<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Integrated vs Functional testing: how to test REST APIs in Grails using Spock</title>

    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!--Responsive Meta Tags-->
    <meta name="HandheldFriendly" content="True"/>
    <meta name="MobileOptimized" content="320"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <!--Bing search engine validation-->
    <meta name="msvalidate.01" content="C6990C0351F7B20ED3C944A3BB3BECD9"/>

    <!--Styles, change style.css-->
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="../../../vendor/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Poly|Roboto:400,700,300|Roboto+Condensed' rel='stylesheet' type="text/css">
    <link rel="stylesheet" type="text/css" href="../../../css/style.css"/>
    <link rel="stylesheet" href="http://yandex.st/highlightjs/8.0/styles/googlecode.min.css">
    <style>
        #themecover_mobileworking_willsong {
            background: url(../../../img/background.png) repeat-y;
            background-size: 100%;
            height: 100%;
            left: 0;
            position: fixed;
            top: 30px;
            width: 100%;
            z-index: -100;
        }
    </style>

    <!--Scripts-->
    <script src="//code.jquery.com/jquery-2.1.0.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.0/js/bootstrap.min.js"></script>
    <script src="http://yandex.st/highlightjs/8.0/highlight.min.js"></script>


    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../../../favicon.ico">
</head>
<div id="themecover_mobileworking_willsong"></div>
	<!-- Fixed navbar -->
    <nav id="mainnav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a id="blogname_willsong" class="navbar-brand" href="../../../">
            aruizca&#x27;s blog = brain.collect {stuff -&gt; post(stuff)}
          </a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
<header id="indexhead_willsong">
    <div id="description_willsong" class="respowidth_willsong">
        <h3>- For anything that is worth writing in more than 140 characters -</h3>

        <h3>For everything else follow me <a href="https://twitter.com/aruizca" target="_twitter">@aruizca <i class="fa fa-twitter fa-lg"></i></a></h3>
    </div>
</header>
<section id="main_willsong" role="main">
	<article id="thearticle_willsong" class="respowidth_willsong" role="article" itemscope
			 itemtype="http://schema.org/Article">
		<h2 class="posttitle_willsong" itemprop="headline">Integrated vs Functional testing: how to test REST APIs in Grails using Spock</h2>

		<div class="articledetails_willsong">

			<i class="fa fa-clock-o fa-lg"></i><span><time class="date_willsong" datetime="19 March 2015" itemprop="datePublished">19 March 2015</time></span>
			<i class="fa fa-user fa-lg"></i><span>Angel Ruiz</span>
			<i class="fa fa-tag fa-lg"></i><span>grails, spock, testing</span>
		</div>

		<div class="postcontent_willsong">
			<p><a href="https://spockframework.org/" target="_blank"><br> <img src="https://aruizca.com/blog/2015/img/grails-spock.png" alt="Grails and Spock"><br> </a></p> 
<div class="alert alert-warning"> <i class="fa fa-exclamation-triangle fa-fw"></i> This guide was written using <strong>Grails 2.4.4</strong> although it should work the same for Grails 2.3.x and 3.x (almost the same :-P)
 <br> 
</div> 
<p>Since current <a href="http://grails.github.io/grails-doc/2.4.x/guide/testing.html">official documentation</a> only covers unit testing for controllers and that it took me a while to to figure them out completely, I thought I would leave it here in case it helps someone else.</p> 
<p>The reason for writing these tests was to validate some REST API endpoints implemented using Grails Controllers.</p> 
<p>So given the following simple and pure didactic domain object:</p> 
<pre><code class="language-groovy">class Book {

    String title

    static constraints = {
        title blank: false, unique: true
    }
}
</code></pre> 
<p>and its respective controller:</p> 
<pre><code class="language-groovy">import grails.converters.JSON
import grails.rest.RestfulController

class BookController extends RestfulController&lt;Book&gt; {
    static responseFormats = ['json']

    BookController() {
        super(Book)
    }

    @Override
    def save() {
        def jsonParams = request.JSON
        render new Book(title: jsonParams.title).save() as JSON
    }
}
</code></pre> 
<p>with its respective URL mapping:</p> 
<pre><code>...
"/books/$id?"(controller: 'book') {
	action = [POST: 'save']
}
...
</code></pre> 
<p>These are the two type of tests you can implement:</p> 
<h2>Integration Test</h2> 
<p>First of all, forget about the <code>@TestFor</code> annotations, because those are just for unit tests.</p> 
<p>This is how the integration test looks like:</p> 
<pre><code class="language-groovy">import grails.test.spock.IntegrationSpec
import rest.sample.Book
import rest.sample.BookController
import spock.lang.Shared

class BookControllerSpec extends IntegrationSpec {

    @Shared BookController controller = new BookController()

    def setup() {
        // Initialize DB
        new Book(title: "title1").save()
    }

    def cleanup() {
    }

    void "test creating a book"() {
        when:
        // Set request JSON body
        controller.request.json = [
            title: "title2"
        ]
        controller.save()
        def response = controller.response.json

        then:
        response.title == "title2"
        Book.count == 2
    }
}
</code></pre> 
<p>As you can appreciate <strong>this is not really the best way to test a REST API</strong> in my opinion. Not only look a bit cumbersome but also and more importantly, it is not a really end to end (e2e) test.</p> 
<p>So how do we implemet a complete e2e test using a REST client if the Integration tests does not run a web server and Grails lacks built-in support for Functional testing (Grails 3.x <a href="http://grails.github.io/grails-doc/3.0.x/guide/testing.html#functionalTesting">has it</a>)? Let's find the answer in the next section.</p> 
<h2>Functional Test</h2> 
<p>First of all we need to enable functional test via plugin. There are quite a few to choose from but we need those that support Spock tests like:</p> 
<ul> 
 <li><a href="https://grails.org/plugin/funky-spock">Funcky Spock Plugin</a>: which is good enough to test a REST API.</li> 
 <li><a href="https://grails.org/plugin/geb">Geb integration for Grails Plugin</a>: on top of enabling functional Spock tests, it also allows you to use the <a href="http://www.gebish.org/"><strong>Geb</strong> e2e browser testing framework</a></li> 
</ul> 
<p>Although the first one is more than enough, I chose the Geb plugin to be inline with Grails 3 choice :-) <strong>To integrate the Geb plugin</strong>, we need to add the following dependencies in our <code>BuildConfig.groovy</code>:</p> 
<pre><code>dependencies {
  ...
  test "org.gebish:geb-spock:0.10.0"
  ...
}

plugins {
  ...
  test ":geb:0.10.0"
  ...
}
</code></pre> 
<p>Then I had to create the folder: <code>/tests/functional</code> to put our functional tests there.</p> 
<p>As the REST client I will be using the <a href="http://grails.org/plugin/rest-client-builder"><strong>Rest Client Builder plugin</strong></a>.</p> 
<p>This is how the functional test looks like with the forementioned "ingredients":</p> 
<pre><code class="language-groovy">import grails.plugins.rest.client.RestBuilder
import grails.plugins.rest.client.RestResponse
import grails.test.spock.IntegrationSpec
import rest.sample.Book
import spock.lang.Shared

class BookControllerFunctionalSpec extends IntegrationSpec {
    
    @Shared
    def grailsApplication

    def setup() {
        // Initialize DB
        new Book(title: "title1").save()
    }

    def cleanup() {
    }

    void "test creating a book"() {
        given:
        RestBuilder rest = new RestBuilder()

        when:
        RestResponse response = rest.post("http://localhost:8080/${grailsApplication.metadata.'app.name'}/books") {
            json([
                title: "title2"
            ])
        }

        then:
        response.status == 200
        response.json.title == "title2"
        Book.count == 2
    }
}
</code></pre> 
<p>Thank you for reaching this paragraph. I hope it helped you. If any of you guys think there is a better approach, by all means, please let me know.</p> 
<p>You can find the rpoject with the source code here: <a href="https://github.com/aruizca/rest-api-test-example">https://github.com/aruizca/rest-api-test-example</a></p>
		</div>

		<div id="sharepost_willsong">
			<span>Share this post:</span><br><br>
			<a class="sharelink_willsong" target="_blank"
			   href="http://www.facebook.com/sharer.php?u={{url absolute="true"}}"><i class="fa fa-facebook fa-lg"></i></a>
			<a class="sharelink_willsong" target="_blank"
			   href="http://twitter.com/share?text={{title}}&url={{url absolute="true"}}"><i class="fa fa-twitter fa-lg"></i></a>
			<a class="sharelink_willsong" target="_blank"
			   href="https://plus.google.com/share?url={{url absolute="true"}}"><i class="fa fa-google-plus-square fa-lg"></i></a>
		</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'aruizca'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>	</article>
</section>

	

<footer>
    <!--Social Media -->
    <div id="socialmedia_willsong">
        <a href="https://twitter.com/aruizca" class="sociallink_willsong"><i class="fa fa-twitter fa-lg"></i></a>
        <a href="https://www.linkedin.com/in/angelruiz/" target="linkedin" class="sociallink_willsong"><i class="fa fa-linkedin fa-lg"></i></a>
        <a href="{{@blog.url}}/rss" target="_rss" class="sociallink_willsong"><i class="fa fa-rss fa-lg"></i></a>
    </div>

    <p id="copyright_willsong">
        <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">aruizca's blog</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://aruizca.com" property="cc:attributionName" rel="cc:attributionURL">Angel Ruiz Calvo</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
        <br/>
        Proudly baked with <a href="https://jbake.org/" target="_blank">JBake</a>. Look&Feel based on Wilson theme created by <a href="http://marcosn.com" target="_blank">Marcosn.com</a>
    </p>
</footer>

<script src="../../../vendor/jquery/jquery.fitvids.js"></script>
<script src="../../../vendor/jquery/jquery.appear.js"></script>
<script src="../../../js/main.js"></script>
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-41135257-3', 'aruizca.com');
    ga('require', 'linkid', 'linkid.js');
    ga('send', 'pageview');

</script>
    
